# Итоговое задание курса Java PRO от T1 Academy

## Задание
Реализовать REST микросервис лимитов, который имеет следующих функционал:
- Для каждого юзера в БД хранится дневной лимит возможных платежей (первоначально 10000.00. Считаем, что раз в несколько месяцев он может меняться)
- В 00.00 каждого дня лимит для всех пользователей должен быть сброшен
- Про успешном проведении платежа лимит должен быть уменьшен на соответствующую сумму
- Если вдруг платеж по какой-то причине не прошел, необходимо иметь возможность восстановить списанный лимит (тут сами выбираете стратегию уменьшения/восстановления лимитов)
- Поскольку сервиса клиентов у нас нет, в БД храним лимиты для «клиентов» с ID 1-100
- Поскольку считаем, что gateway не пропустит в систему несуществующего клиента, то при запросе лимита с ID, который отсутствует в БД, создаем новую запись под него со стандартным значением лимита


## Краткое описание работы реализованного решения

Для контроля лимитов в БД будут создаваться записи, содержащие идентификатор пользователя, его максимальный лимит, текущий доступный лимит и дату, для которой этот лимит применяется.
При всех проверках входящих запросов текущей датой считается дата на сервере приложения.
При смене даты в БД начнут записываться новые записи с лимитами на новую дату. 
Старые записи за предыдущие дни будут удалены процессом очистки, запускаемым по расписанию.
Процесс очистки удаляет данные пакетами, блокируя от чтения прочитанный пакет, что позволяет работать одновременно нескольким инстансам приложения.

### Получение лимита
Метод для получения лимита возвращает остаток лимита на текущую дату. 
Если пользователь отсутствует в базе, то он будет добавлен и ему будет установлен лимит по умолчанию на текущую дату.

### Изменение лимита
Если пользователь отсутствует в базе, то он будет добавлен и ему будет установлен лимит по умолчанию на текущую дату.
Метод изменения лимита попытается уменьшить лимит для пользователя на текущую дату. 
Если в результате изменения лимит будет превышен, будет возвращена ошибка 422.

### Метод отката лимита
Вернет указанную сумму обратно к доступной сумме. 
Если в результате будет превышен лимит на день, то доступная сумма будет установлена равной сумме лимита.
Если пользователь с указанным идентификатором будет отсутствовать в базе, будет возвращена ошибка 404.


## Генерация интерфейсов и dto для контроллеров
Интерфейсы и dto для rest-контроллеров не созданы явным образом, а генерируются на основе спецификации OpenApi.

Чтобы перегенерировать классы, можно было бы запустить плагин-генератор, но я что-то не могу
заставить его работать корректно отдельно. Только в контексте компиляции.
Поэтому, чтобы обновить классы после изменений спецификации, надо скомпилировать проект.
```shell
mvn clean compile
```
После успешной компиляции ищи готовые классы и интерфейсы в `target/generated-sources/main/java/src/main/java/org/example`

Поведение генератора настраивается в `pom.xml` в настройках `openapi-generator-maven-plugin`


## Запуск тестов

> Нужен установленный Docker и доступ в интернет для скачивания образа postgres:15-alpine
 
Запуск теста: `mvn clean verify` из корневого каталога.

> К сожалению полноценные тесты написать не успел, прошу понять и простить. Конец курса пришелся на подготовку релиза другого проекта...
> И логирование тоже((

## Запуск приложения вручную в тестовом режиме

Запуск приложения в тестовом режиме: запустить `src/test/java/org/example/LimitServiceTestApplication#main()` через Intellij Idea

[swagger-ui](http://localhost:8096/swagger-ui/index.html)
